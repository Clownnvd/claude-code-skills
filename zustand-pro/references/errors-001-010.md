# Common Errors & Fixes (ZST-001 to ZST-010)

## ZST-001: Hydration Mismatch with Persist

**Error:**
```
Text content does not match server-rendered HTML.
Hydration failed because the initial UI does not match what was rendered on the server.
```

**Cause:** Persist middleware loads data from localStorage on the client, but the server renders with default state.

**Fix A -- useHydratedStore hook:**
```tsx
'use client'
import { useState, useEffect } from 'react'

export function useHydratedStore<S, T>(
  store: (selector: (s: S) => T) => T,
  selector: (s: S) => T,
  fallback: T
): T {
  const [hydrated, setHydrated] = useState(false)
  const value = store(selector)

  useEffect(() => setHydrated(true), [])

  return hydrated ? value : fallback
}

// Usage:
const theme = useHydratedStore(useSettingsStore, (s) => s.theme, 'light')
```

**Fix B -- skipHydration + manual rehydrate:**
```typescript
const useStore = create(persist(/* ... */, { skipHydration: true }))

// In client layout:
useEffect(() => { useStore.persist.rehydrate() }, [])
```

**Fix C -- next/dynamic with ssr: false:**
```tsx
import dynamic from 'next/dynamic'
const ThemeToggle = dynamic(() => import('./theme-toggle'), { ssr: false })
```

---

## ZST-002: Infinite Re-render Loop (v5)

**Error:**
```
Maximum update depth exceeded. This can happen when a component repeatedly calls setState inside componentWillUpdate or componentDidUpdate.
```

**Cause:** In v5, selectors that return new object/array references trigger re-renders. Unlike v4, v5 uses `Object.is` equality by default.

**Fix -- use `useShallow`:**
```tsx
import { useShallow } from 'zustand/shallow'

// BEFORE (infinite loop in v5):
const { name, email } = useStore((s) => ({ name: s.name, email: s.email }))

// AFTER (stable reference):
const { name, email } = useStore(
  useShallow((s) => ({ name: s.name, email: s.email }))
)
```

**Fix -- use `createWithEqualityFn` (global v4 behavior):**
```typescript
import { createWithEqualityFn } from 'zustand/traditional'
import { shallow } from 'zustand/shallow'

const useStore = createWithEqualityFn<State>()(
  (set) => ({ /* ... */ }),
  shallow // Use shallow equality globally
)
```

---

## ZST-003: "Cannot use hook in Server Component"

**Error:**
```
Error: Cannot read properties of null (reading 'useRef')
```
or
```
Error: (0, react__WEBPACK_IMPORTED_MODULE_0__.createContext) is not a function
```

**Cause:** Importing/using a Zustand store hook in a Server Component.

**Fix:** Add `'use client'` to the component that uses the store, or restructure to pass data as props from the Server Component.

```tsx
// Server Component (page.tsx)
export default async function Page() {
  const data = await fetchData()
  return <ClientEditor initialData={data} />
}

// Client Component (client-editor.tsx)
'use client'
import { useEditorStore } from '@/stores/editor-store'
export function ClientEditor({ initialData }: { initialData: Data }) {
  const setData = useEditorStore((s) => s.setData)
  useEffect(() => { setData(initialData) }, [initialData, setData])
  // ...
}
```

---

## ZST-004: Store State Not Updating Between Components

**Error:** Component A updates store, but Component B does not re-render.

**Cause 1:** Direct object mutation instead of immutable update.

```typescript
// WRONG: mutating state directly
set((state) => {
  state.items.push(newItem) // Mutation! Zustand won't detect change
  return state
})

// CORRECT: return new reference
set((state) => ({
  items: [...state.items, newItem]
}))

// CORRECT with immer middleware: mutations are OK
set((state) => {
  state.items.push(newItem) // Fine with immer
})
```

**Cause 2:** Creating multiple store instances (module executed multiple times).

**Fix:** Ensure the store module is imported from the same path consistently. Avoid dynamic imports that create new instances.

---

## ZST-005: TypeScript Error with Middleware Chaining

**Error:**
```
Type '...' is not assignable to type 'StateCreator<...>'.
```

**Cause:** Missing the extra `()` in `create<Type>()((set) => ...)` or incorrect middleware type parameters.

**Fix:**
```typescript
// WRONG:
const useStore = create<MyState>((set) => ({ /* ... */ }))

// CORRECT (the extra () is critical for TypeScript):
const useStore = create<MyState>()((set) => ({ /* ... */ }))
```

---

## ZST-006: Persist Storage Unavailable (SSR)

**Error:**
```
Unable to update item 'my-store', the given storage is currently unavailable.
```

**Cause:** `localStorage` is not available during SSR (server-side rendering).

**Fix:**
```typescript
const useStore = create(
  persist(
    (set) => ({ /* ... */ }),
    {
      name: 'my-store',
      storage: createJSONStorage(() => {
        if (typeof window === 'undefined') {
          // Return a noop storage for SSR
          return {
            getItem: () => null,
            setItem: () => {},
            removeItem: () => {},
          }
        }
        return localStorage
      }),
    }
  )
)
```

---

## ZST-007: `useShallow` Not Found / Import Error

**Error:**
```
Module '"zustand/shallow"' has no exported member 'useShallow'.
```

**Cause:** Using Zustand v4 (useShallow was introduced in v4.5+ and is standard in v5).

**Fix:** Upgrade to zustand >= 4.5 or >= 5.0:
```bash
pnpm add zustand@latest
```

---

## ZST-008: DevTools Not Showing Store

**Cause 1:** Redux DevTools extension not installed.
**Cause 2:** `devtools` middleware not wrapping the store.
**Cause 3:** `enabled: false` in devtools options (e.g., production build).

**Fix:**
```typescript
const useStore = create<State>()(
  devtools(
    (set) => ({ /* ... */ }),
    {
      name: 'MyStore', // Required for identification
      enabled: process.env.NODE_ENV === 'development',
    }
  )
)
```

---

## ZST-009: Persist State Overwriting New Fields After Schema Update

**Error:** After adding a new field to the store, persisted old state overwrites it with `undefined`.

**Cause:** Shallow merge doesn't include new fields from the updated store.

**Fix -- Use `merge` option with proper defaults:**
```typescript
persist(
  (set) => ({
    theme: 'light',
    fontSize: 14,    // New field added in v2
    /* ... */
  }),
  {
    name: 'settings',
    version: 2,
    merge: (persisted, current) => ({
      ...current,     // Start with current defaults (includes new fields)
      ...(persisted as Partial<typeof current>),  // Override with persisted
    }),
    migrate: (persisted, version) => {
      if (version < 2) {
        return { ...(persisted as any), fontSize: 14 }
      }
      return persisted
    },
  }
)
```

---

## ZST-010: Async Action Not Updating State

**Error:** State update inside `async` action doesn't trigger re-render.

**Cause:** Using `get()` instead of `set()` after await, or forgetting that `set` is needed.

**Fix:**
```typescript
const useStore = create<State>()((set, get) => ({
  data: null,
  loading: false,
  error: null,

  fetchData: async () => {
    set({ loading: true, error: null })
    try {
      const response = await fetch('/api/data')
      const data = await response.json()
      set({ data, loading: false })        // Use set(), not direct mutation
    } catch (error) {
      set({ error: (error as Error).message, loading: false })
    }
  },
}))
```
