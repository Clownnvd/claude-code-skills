{
  "skill": "db-fix",
  "eval_name": "eval-fix-patterns",
  "description": "Verify specific fix patterns from references/fix-patterns/ produce correct code changes for database issues.",
  "tests": [
    {
      "id": "string-to-enum-conversion",
      "name": "String-to-Enum Conversion (schema-integrity.md)",
      "prompt": "Apply String-to-Enum pattern to convert string fields to Prisma enums",
      "setup": "`Purchase.paymentMethod` is `String @default(\"stripe\")` instead of an enum. No type safety on values.",
      "input_files": [],
      "expectations": [
        "Apply String-to-Enum pattern",
        "Verify `enum PaymentMethod { STRIPE SEPAY }` created in schema.prisma",
        "Verify model field changed to `paymentMethod PaymentMethod @default(STRIPE)`",
        "Verify application code updated to use enum or uppercase string literals"
      ],
      "pass_criteria": "`prisma validate` passes. Application code uses `PaymentMethod.STRIPE` or `\"STRIPE\"`. Migration SQL contains `CREATE TYPE`. Default value matches enum member.",
      "fail_indicators": [
        "Schema invalid, or application code still uses lowercase `\"stripe\"`, or migration drops data"
      ]
    },
    {
      "id": "foreign-key-indexes",
      "name": "Foreign Key Indexes (performance-scaling.md)",
      "prompt": "Apply FK Indexes pattern to add indexes on foreign key columns",
      "setup": "`Purchase.userId` is a foreign key with no `@@index`. Queries by userId do sequential scans.",
      "input_files": [],
      "expectations": [
        "Apply FK Indexes pattern",
        "Verify `@@index([userId])` added to Purchase model",
        "Verify composite index `@@index([userId, status])` added for common query pattern",
        "Verify migration generated cleanly"
      ],
      "pass_criteria": "`prisma migrate dev` creates index migration without data changes. `EXPLAIN` on `WHERE userId = ?` shows index scan. Composite index covers `WHERE userId = ? AND status = ?`.",
      "fail_indicators": [
        "Indexes not added, or index on wrong columns, or migration fails"
      ]
    },
    {
      "id": "sensitive-field-exposure-fix",
      "name": "Sensitive Field Exposure Fix (security.md)",
      "prompt": "Apply Sensitive Field Exposure pattern to prevent leaking password hashes and tokens",
      "setup": "API route calls `prisma.user.findUnique({ where: { id } })` without `select`, exposing password hash and tokens in response.",
      "input_files": [],
      "expectations": [
        "Apply Sensitive Field Exposure pattern",
        "Verify all user queries have explicit `select` clause",
        "Verify password, accessToken, refreshToken never selected",
        "Verify audit: `grep` for findUnique/findFirst/findMany without select"
      ],
      "pass_criteria": "Every Prisma query touching User model uses `select`. No sensitive fields in API responses. Audit finds zero unprotected queries.",
      "fail_indicators": [
        "Some queries still return full model, or select clause incomplete"
      ]
    },
    {
      "id": "connection-pooling",
      "name": "Connection Pooling (performance-scaling.md)",
      "prompt": "Apply Connection Pooling pattern to configure separate pooled and direct database URLs",
      "setup": "Single `DATABASE_URL` used for both queries and migrations. No pgbouncer parameter. `DIRECT_URL` not configured.",
      "input_files": [],
      "expectations": [
        "Apply Connection Pooling pattern",
        "Verify `prisma.config.ts` has separate `url` and `directUrl`",
        "Verify `DATABASE_URL` includes `?pgbouncer=true&sslmode=require`",
        "Verify `DIRECT_URL` includes `?sslmode=require` without pgbouncer"
      ],
      "pass_criteria": "Pooled URL used for application queries. Direct URL used for migrations. Both enforce SSL. `.env.example` documents both variables.",
      "fail_indicators": [
        "Only one URL configured, or SSL missing, or pgbouncer on direct URL"
      ]
    }
  ]
}
