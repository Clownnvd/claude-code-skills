{
  "skill": "auth-fix",
  "eval_name": "eval-verification-loop",
  "description": "Verify the compile-test-rescore cycle, regression detection, and fix idempotency for auth-fix.",
  "tests": [
    {
      "id": "compile-test-verification",
      "name": "Compile + Test Verification",
      "prompt": "Apply the CSRF token fix and verify compilation and auth flow tests pass",
      "setup": "Scorecard with CRITICAL issue: sessions lack CSRF protection (CSRF & Headers 3/10). Apply the CSRF token fix from `csrf-headers.md` which adds token generation, validation middleware, and hidden form fields.",
      "input_files": [],
      "expectations": [
        "Apply CSRF token generation to session creation in `src/lib/auth.ts`",
        "Add CSRF validation middleware to state-changing API routes",
        "Run `npx tsc --noEmit`. Verify zero type errors from new token types",
        "Run `pnpm test`. Verify login, logout, and OAuth callback tests still pass"
      ],
      "pass_criteria": "`tsc --noEmit` exits 0. All auth flow tests pass. CSRF token type is exported and consistent across middleware and session module. No broken imports.",
      "fail_indicators": [
        "Type mismatch between token shape in session vs middleware, or existing auth tests fail due to missing CSRF token in test fixtures"
      ]
    },
    {
      "id": "re-score-improvement-verification",
      "name": "Re-Score Improvement Verification",
      "prompt": "Apply fixes for Sessions and CSRF & Headers categories and verify re-score improvement",
      "setup": "Initial auth-scoring scorecard: Sessions 5/10, CSRF & Headers 3/10, Passwords 7/10. Total 52/100 (C-). Apply fixes for session `httpOnly`/`secure` flags (Sessions) and CSRF token validation (CSRF & Headers).",
      "input_files": [],
      "expectations": [
        "Run auth-fix for both issues",
        "Invoke `auth-scoring` to produce a new scorecard",
        "Compare per-category scores: Sessions, CSRF & Headers must increase",
        "Verify Passwords, OAuth, Rate Limiting, and all other categories remain at or above pre-fix scores"
      ],
      "pass_criteria": "Sessions >= 7/10 (was 5). CSRF & Headers >= 6/10 (was 3). No category dropped below its pre-fix score. Total weighted score increased. Comparison uses `references/verification.md` template.",
      "fail_indicators": [
        "Any unfixed category score decreased, or fixed categories show no improvement"
      ]
    },
    {
      "id": "regression-detection",
      "name": "Regression Detection",
      "prompt": "Apply a CSRF fix that introduces an OAuth regression and verify pipeline detects it",
      "setup": "Initial scorecard: Sessions 8/10, OAuth 7/10, CSRF & Headers 5/10. Apply a CSRF fix that adds strict `SameSite=Strict` cookies, breaking the OAuth callback flow. OAuth drops from 7/10 to 3/10.",
      "input_files": [],
      "expectations": [
        "Apply CSRF fix with `SameSite=Strict` on all cookies including OAuth state",
        "Run `auth-scoring` re-score",
        "Verify pipeline detects OAuth dropped from 7 to 3 (delta -4)",
        "Verify pipeline halts and recommends reverting the cookie change"
      ],
      "pass_criteria": "Pipeline detects the OAuth regression. Output flags: OAuth category regressed, before/after delta shown, recommendation to use `SameSite=Lax` for OAuth cookies instead. Pipeline does not continue fixing.",
      "fail_indicators": [
        "Pipeline ignores the OAuth drop and continues, or reports net improvement without flagging the per-category regression"
      ]
    },
    {
      "id": "fix-idempotency",
      "name": "Fix Idempotency",
      "prompt": "Run auth-fix with an already-fixed CSRF issue and verify no changes are made",
      "setup": "Scorecard with CRITICAL issue: no CSRF protection. The `src/lib/auth.ts` already generates CSRF tokens and `src/middleware.ts` already validates them from a previous fix run.",
      "input_files": [],
      "expectations": [
        "Run auth-fix with the same CSRF issue",
        "Check `git diff` after the fix attempt",
        "Run `auth-scoring` and compare scores to the post-first-fix scorecard"
      ],
      "pass_criteria": "No files modified (`git diff` is empty). Score remains identical. Skill reports \"already applied\" or \"no changes needed\" for the CSRF item. No duplicate token generation or validation logic inserted.",
      "fail_indicators": [
        "Second CSRF middleware added, duplicate token field in session, or score changes from the second application"
      ]
    }
  ]
}
