{
  "skill": "auth-fix",
  "eval_name": "eval-fix-patterns",
  "description": "Verify specific fix patterns from references/fix-patterns/ produce correct code changes for auth issues.",
  "tests": [
    {
      "id": "cookie-security-flags",
      "name": "Cookie Security Flags (sessions-passwords.md)",
      "prompt": "Apply Cookie Security Flags pattern to Better Auth config",
      "setup": "Better Auth config missing `useSecureCookies` and explicit `defaultCookieSameSite`.",
      "input_files": [],
      "expectations": [
        "Apply Cookie Security Flags pattern",
        "Verify `advanced.useSecureCookies` set to `process.env.NODE_ENV === \"production\"`",
        "Verify `advanced.defaultCookieSameSite` set to `\"lax\"` (not `\"strict\"`, which breaks OAuth)"
      ],
      "pass_criteria": "Cookies use `Secure` flag in production, `SameSite=Lax` always. Cookie prefix configured.",
      "fail_indicators": [
        "`SameSite` set to `\"strict\"` (breaks OAuth redirects), or `useSecureCookies` hardcoded to `true` (breaks dev)"
      ]
    },
    {
      "id": "origin-validation-in-proxy",
      "name": "Origin Validation in Proxy (csrf-headers.md)",
      "prompt": "Apply Origin Validation pattern to add CSRF protection on state-changing requests",
      "setup": "No CSRF protection on state-changing requests. POST to `/api/auth/*` accepts any origin.",
      "input_files": [],
      "expectations": [
        "Apply Origin Validation pattern",
        "Verify `validateOrigin()` function added to proxy.ts",
        "Verify safe methods (GET, HEAD, OPTIONS) skip validation",
        "Verify POST requests require matching Origin or Referer header"
      ],
      "pass_criteria": "State-changing requests rejected when Origin header mismatches `BETTER_AUTH_URL`. GET requests pass through. Missing Origin + missing Referer on POST returns false.",
      "fail_indicators": [
        "All requests checked (breaks GETs), or validation only checks Origin but not Referer fallback"
      ]
    },
    {
      "id": "strict-auth-rate-limits",
      "name": "Strict Auth Rate Limits (ratelimit-audit.md)",
      "prompt": "Apply Strict Auth Rate Limits pattern with tiered rate limiting for auth endpoints",
      "setup": "No rate limiting on login, signup, or password reset endpoints.",
      "input_files": [],
      "expectations": [
        "Apply Strict Auth Rate Limits pattern",
        "Verify `AUTH_RATE_LIMITS` config defined with strict (5 req/15min), standard (100 req/15min), verification (3 req/1hr) tiers",
        "Verify sign-in and sign-up routes use strict limits"
      ],
      "pass_criteria": "Login endpoint rejects after 5 attempts in 15 minutes. Returns 429 with `Retry-After` header. Verification email endpoint limited to 3/hour.",
      "fail_indicators": [
        "Rate limits too permissive (>20 for auth), or no differentiation between auth and general routes"
      ]
    },
    {
      "id": "two-layer-auth-pattern",
      "name": "Two-Layer Auth Pattern (authz-2fa.md)",
      "prompt": "Apply Two-Layer Auth pattern with proxy-level cookie check and API-level session validation",
      "setup": "No proxy-level cookie check. All auth relies on API route `getSession()` calls.",
      "input_files": [],
      "expectations": [
        "Apply Two-Layer Auth pattern",
        "Verify Layer 1: Proxy checks `better-auth.session_token` cookie for protected paths",
        "Verify Layer 2: API routes use `requireAuth()` for full session validation",
        "Verify redirect includes `callbackUrl` search parameter"
      ],
      "pass_criteria": "Unauthenticated requests to `/dashboard` redirect to `/sign-in?callbackUrl=/dashboard` at proxy level. API routes still validate session with DB lookup via `requireAuth()`.",
      "fail_indicators": [
        "Only one layer exists, or proxy does DB lookup (too heavy), or callbackUrl missing"
      ]
    }
  ]
}
