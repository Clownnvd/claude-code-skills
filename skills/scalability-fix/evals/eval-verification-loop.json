{
  "skill": "scalability-fix",
  "eval_name": "eval-verification-loop",
  "description": "Verify the compile-test-rescore cycle, regression detection, and fix idempotency for scalability-fix.",
  "tests": [
    {
      "id": "compile-test-verification",
      "name": "Compile + Test Verification",
      "prompt": "Apply the Dynamic Import fix and verify compilation, tests, and bundle splitting",
      "setup": "Scorecard with CRITICAL issue: heavy library (`chart.js`, 200KB) imported at top level in a client component (Bundle Size 3/10). Apply the Dynamic Import fix from `bundle-images.md` which converts to `next/dynamic` with `{ ssr: false }`.",
      "input_files": [],
      "expectations": [
        "Replace `import Chart from 'chart.js'` with `const Chart = dynamic(() => import('chart.js'), { ssr: false })`",
        "Run `npx tsc --noEmit`. Verify zero type errors from dynamic import wrapper",
        "Run `pnpm test`. Verify chart component tests still pass (mock may need update)",
        "Run `pnpm build`. Verify bundle analyzer (if available) shows chart.js in a separate chunk"
      ],
      "pass_criteria": "`tsc --noEmit` exits 0. All tests pass. Build succeeds with chart.js code-split into its own chunk. No `'use client'` directive added to a previously server-rendered parent.",
      "fail_indicators": [
        "Type error from dynamic component props, test failure from SSR mismatch, or chart.js still in main bundle"
      ]
    },
    {
      "id": "re-score-improvement-verification",
      "name": "Re-Score Improvement Verification",
      "prompt": "Apply fixes for Bundle Size and DB Performance categories and verify re-score improvement",
      "setup": "Initial scalability-scoring scorecard: Bundle Size 3/10, RSC Architecture 5/10, DB Performance 4/10. Total 44/100 (D+). Apply fixes for dynamic imports (Bundle Size) and N+1 query batching with `Promise.all` (DB Performance).",
      "input_files": [],
      "expectations": [
        "Run scalability-fix for both issues",
        "Invoke `scalability-scoring` to produce a new scorecard",
        "Compare per-category scores: Bundle Size, DB Performance must increase",
        "Verify RSC Architecture, Concurrency, Rendering, and all other categories remain at or above pre-fix scores"
      ],
      "pass_criteria": "Bundle Size >= 6/10 (was 3). DB Performance >= 7/10 (was 4). No category dropped below its pre-fix score. Total weighted score increased. N+1 queries replaced with batched `Promise.all` or `findMany({ where: { id: { in: ids } } })`.",
      "fail_indicators": [
        "Any unfixed category score decreased, or N+1 pattern still present in fixed queries"
      ]
    },
    {
      "id": "regression-detection",
      "name": "Regression Detection",
      "prompt": "Apply a bundle size fix that introduces an RSC Architecture regression and verify pipeline detects it",
      "setup": "Initial scorecard: RSC Architecture 8/10, Bundle Size 7/10, Rendering 7/10. Apply a bundle size fix that adds `\"use client\"` to a shared layout component to enable dynamic imports, moving server-rendered content to client. RSC Architecture drops from 8/10 to 4/10.",
      "input_files": [],
      "expectations": [
        "Apply `\"use client\"` to `src/app/layout.tsx` to support dynamic chart import",
        "Run `scalability-scoring` re-score",
        "Verify pipeline detects RSC Architecture dropped from 8 to 4 (delta -4)",
        "Verify pipeline halts and recommends extracting the chart into a leaf Client Component instead"
      ],
      "pass_criteria": "Pipeline detects the RSC Architecture regression. Output flags: layout converted to Client Component unnecessarily, before/after delta shown, recommendation to isolate `\"use client\"` to leaf components. Pipeline does not continue.",
      "fail_indicators": [
        "Pipeline ignores the RSC regression and continues, or fails to identify that `\"use client\"` on layout caused the architecture score drop"
      ]
    },
    {
      "id": "fix-idempotency",
      "name": "Fix Idempotency",
      "prompt": "Run scalability-fix with an already-fixed bundle size issue and verify no changes are made",
      "setup": "Scorecard with CRITICAL issue: heavy library at top level. The chart component already uses `next/dynamic` with `{ ssr: false }` from a previous fix run.",
      "input_files": [],
      "expectations": [
        "Run scalability-fix with the same bundle size issue",
        "Check `git diff` after the fix attempt",
        "Run `scalability-scoring` and compare scores to the post-first-fix scorecard"
      ],
      "pass_criteria": "No files modified (`git diff` is empty). Score remains identical. Skill reports \"already applied\" or \"no changes needed.\" No nested dynamic wrappers or duplicate `ssr: false` configurations.",
      "fail_indicators": [
        "Double-wrapped dynamic import, duplicate loading component, or score changes from the second application"
      ]
    }
  ]
}
