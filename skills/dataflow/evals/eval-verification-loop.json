{
  "skill": "dataflow",
  "eval_name": "eval-verification-loop",
  "description": "Verify the compile-test-rescore cycle, regression detection, and fix idempotency for dataflow-fix.",
  "tests": [
    {
      "id": "compile-test-verification",
      "name": "Compile + Test Verification",
      "prompt": "Apply the Prisma Select fix and verify compilation and tests pass",
      "setup": "Scorecard with HIGH issue: Prisma queries use `findMany()` without `select`, returning full models to client (Prisma & API 4/10). Apply the Prisma Select fix from `prisma-api.md`.",
      "input_files": ["references/fix/verification.md", "references/scoring/scoring-workflow.md"],
      "expectations": [
        "Add explicit `select` clauses to all `findMany`/`findFirst` calls, returning only fields needed by the UI",
        "Update corresponding TypeScript return types to match narrowed select shape",
        "Run `npx tsc --noEmit`. Verify zero type errors from narrowed Prisma types",
        "Run `pnpm test`. Verify data-fetching tests and component render tests still pass"
      ],
      "pass_criteria": "`tsc --noEmit` exits 0. All tests pass. Prisma return types match `select` shape (no `Property does not exist` errors). Components receive only declared fields.",
      "fail_indicators": [
        "Type error from accessing fields excluded by `select`, or component tests fail due to missing properties in narrowed data"
      ]
    },
    {
      "id": "re-score-improvement-verification",
      "name": "Re-Score Improvement Verification",
      "prompt": "Apply fixes for RSC Composition and Prisma & API categories and verify re-score improvement",
      "setup": "Initial dataflow-scoring scorecard: RSC Composition 5/10, Prisma & API 4/10, Types & Errors 6/10. Total 50/100 (C-). Apply fixes for RSC boundary extraction (RSC Composition) and Prisma `select` clauses (Prisma & API).",
      "input_files": ["references/fix/verification.md", "references/scoring/scoring-workflow.md"],
      "expectations": [
        "Run dataflow-fix for both issues",
        "Invoke `dataflow-scoring` to produce a new scorecard",
        "Compare per-category scores: RSC Composition, Prisma & API must increase",
        "Verify Types & Errors, State & Cache, Forms & DTOs, and all other categories remain at or above pre-fix scores"
      ],
      "pass_criteria": "RSC Composition >= 7/10 (was 5). Prisma & API >= 7/10 (was 4). No category dropped below its pre-fix score. Total weighted score increased. Comparison uses `references/verification.md` template.",
      "fail_indicators": [
        "Any unfixed category score decreased, or fixed categories show no improvement"
      ]
    },
    {
      "id": "regression-detection",
      "name": "Regression Detection",
      "prompt": "Apply an RSC boundary fix that introduces a Forms & DTOs regression and verify pipeline detects it",
      "setup": "Initial scorecard: RSC Composition 8/10, Prisma & API 7/10, Types & Errors 7/10. Apply an RSC boundary fix that moves a form handler into a Server Component without `\"use server\"`, breaking client-side form submission. Forms & DTOs drops from 6/10 to 2/10.",
      "input_files": ["references/fix/verification.md", "references/scoring/scoring-workflow.md"],
      "expectations": [
        "Apply RSC extraction that moves `onSubmit` handler into a Server Component file without adding `\"use server\"` directive",
        "Run `dataflow-scoring` re-score",
        "Verify pipeline detects Forms & DTOs dropped from 6 to 2 (delta -4)",
        "Verify pipeline halts and recommends adding `\"use server\"` or moving handler back to Client Component"
      ],
      "pass_criteria": "Pipeline detects the Forms & DTOs regression. Output flags: category regressed, identifies missing `\"use server\"` directive as root cause, recommends corrective action. Pipeline does not continue.",
      "fail_indicators": [
        "Pipeline ignores the forms regression and continues, or fails to identify the RSC boundary violation"
      ]
    },
    {
      "id": "fix-idempotency",
      "name": "Fix Idempotency",
      "prompt": "Run dataflow-fix with an already-fixed Prisma select issue and verify no changes are made",
      "setup": "Scorecard with HIGH issue: Prisma queries lack `select`. All `findMany` calls in `src/lib/db/` already have explicit `select` clauses from a previous fix run.",
      "input_files": ["references/fix/verification.md", "references/scoring/scoring-workflow.md"],
      "expectations": [
        "Run dataflow-fix with the same Prisma select issue",
        "Check `git diff` after the fix attempt",
        "Run `dataflow-scoring` and compare scores to the post-first-fix scorecard"
      ],
      "pass_criteria": "No files modified (`git diff` is empty). Score remains identical. Skill reports \"already applied\" or \"no changes needed.\" No duplicate `select` clauses or wrapper functions inserted.",
      "fail_indicators": [
        "Redundant `select` nesting added, existing select overwritten, or score changes from the second application"
      ]
    }
  ]
}
