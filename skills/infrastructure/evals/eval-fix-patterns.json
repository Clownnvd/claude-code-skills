{
  "skill": "infrastructure",
  "eval_name": "eval-fix-patterns",
  "description": "Verify specific fix patterns from references/fix-patterns/ produce correct code changes for infrastructure issues.",
  "tests": [
    {
      "id": "github-actions-ci-workflow",
      "name": "GitHub Actions CI Workflow (ci-cd.md)",
      "prompt": "Apply CI Workflow pattern to create a GitHub Actions pipeline with parallel quality gates",
      "setup": "No CI pipeline. Code pushed directly to main without lint, typecheck, or test gates.",
      "input_files": [],
      "expectations": [
        "Apply CI Workflow pattern",
        "Verify `.github/workflows/ci.yml` created",
        "Verify parallel jobs for lint, typecheck, test",
        "Verify build job depends on all three gates (`needs: [lint, typecheck, test]`)",
        "Verify `pnpm install --frozen-lockfile` used (not `pnpm install`)"
      ],
      "pass_criteria": "CI runs on push and PR to main. Jobs run in parallel. Build blocked until gates pass. Concurrency cancels in-progress runs. Each job has `timeout-minutes`.",
      "fail_indicators": [
        "Jobs run sequentially, or no `needs` dependency, or `frozen-lockfile` missing"
      ]
    },
    {
      "id": "env-validation-with-zod",
      "name": "Env Validation with Zod (env-monitoring.md)",
      "prompt": "Apply Env Validation pattern to add Zod-based runtime validation of environment variables",
      "setup": "No runtime validation of environment variables. App crashes with cryptic errors when env vars missing.",
      "input_files": [],
      "expectations": [
        "Apply Env Validation pattern",
        "Verify `src/lib/env.ts` created with `serverSchema` and `clientSchema`",
        "Verify schema uses format checks (e.g., `z.string().startsWith(\"sk_\")` for Stripe key)",
        "Verify validation runs at import time (module-level `parse()`)"
      ],
      "pass_criteria": "App fails fast at startup with clear message when env vars missing. Stripe key validated with prefix. `NEXT_PUBLIC_` vars validated separately. `.env.example` in sync with schema.",
      "fail_indicators": [
        "Validation only at request time, or no format checks, or client vars validated server-side only"
      ]
    },
    {
      "id": "health-and-readiness-endpoints",
      "name": "Health and Readiness Endpoints (env-monitoring.md)",
      "prompt": "Apply Health/Readiness endpoint pattern to add monitoring endpoints",
      "setup": "No health check endpoint. Deployment platform cannot verify app is running.",
      "input_files": [],
      "expectations": [
        "Apply Health/Readiness endpoint pattern",
        "Verify `/api/health` returns `{ status: \"healthy\", timestamp, uptime }`",
        "Verify `/api/ready` checks database connectivity with `SELECT 1`",
        "Verify readiness returns 503 when database unreachable"
      ],
      "pass_criteria": "Health endpoint returns 200 always. Readiness endpoint returns 200 when DB connected, 503 when not. Both return JSON. Docker HEALTHCHECK or deployment platform can use these.",
      "fail_indicators": [
        "No readiness check, or readiness doesn't test DB, or returns 200 when DB is down"
      ]
    },
    {
      "id": "webhook-idempotency",
      "name": "Webhook Idempotency (backup-integrations.md)",
      "prompt": "Apply Idempotency pattern to prevent duplicate webhook processing",
      "setup": "Stripe webhook creates duplicate purchases when same event delivered twice.",
      "input_files": [],
      "expectations": [
        "Apply Idempotency pattern",
        "Verify check-before-create: `findUnique` by `stripePaymentId` before `create`",
        "Verify duplicate returns `{ received: true }` without error",
        "Verify side effects (email, GitHub invite) not re-triggered on duplicate"
      ],
      "pass_criteria": "Second delivery of same webhook event returns 200 without creating duplicate purchase. Logged as \"Duplicate webhook, already processed\". Side effects skipped.",
      "fail_indicators": [
        "Duplicate purchase created, or duplicate returns error status, or side effects fire again"
      ]
    }
  ]
}
