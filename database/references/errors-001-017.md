# Error Database (PERR-001 to PERR-017)

> Connection, Client/Query, and Schema/Migration errors.
> Sources: Prisma docs, Neon docs, GitHub issues, CViet project experience.
> Date: 2026-02-27

---

## Connection Errors

### PERR-001: P1001 — Can't Reach Database Server
```
Error: P1001: Can't reach database server at `ep-xxx-pooler.us-east-2.aws.neon.tech`:`5432`
```
**Cause:** Neon compute scaled to zero (cold start), network issue, or wrong connection string.
**Fix:**
```env
# Add connect_timeout to connection string
DATABASE_URL="postgresql://...?sslmode=require&connect_timeout=15"
```
Or retry logic in application code.

### PERR-002: P1002 — Connection Timeout
```
Error: P1002: The database server at `host`:`5432` was reached but timed out.
```
**Cause:** Database overloaded or slow response.
**Fix:** Increase timeout, check Neon dashboard for compute status, reduce query complexity.

### PERR-003: P1000 — Authentication Failed
```
Error: P1000: Authentication failed against database server at `host`
```
**Cause:** Wrong password, user, or database name in connection string.
**Fix:** Copy fresh connection string from Neon Console > Connect.

### PERR-004: P1003 — Database Does Not Exist
```
Error: P1003: Database `mydb` does not exist on the database server at `host`
```
**Cause:** Wrong database name or branch in Neon.
**Fix:** Check Neon dashboard for correct database name (default: `neondb`).

### PERR-005: P1011 — TLS Connection Error
```
Error: P1011: Error opening a TLS connection: certificate verify failed
```
**Cause:** Prisma 7 validates SSL certificates by default (changed from v6).
**Fix (Prisma 7):**
```typescript
const adapter = new PrismaPg({
  connectionString: process.env.DATABASE_URL!,
  ssl: { rejectUnauthorized: false },
})
```
Or properly: `NODE_EXTRA_CA_CERTS=/path/to/cert.pem` or `node --use-openssl-ca`.

### PERR-006: P1017 — Server Closed Connection
```
Error: P1017: Server has closed the connection.
```
**Cause:** Neon compute suspended mid-query, PgBouncer timeout, or idle connection killed.
**Fix:** Use pooled connection string, implement reconnect logic, increase Neon auto-suspend timeout.

---

## Client & Query Errors

### PERR-007: P2002 — Unique Constraint Violation
```
Error: P2002: Unique constraint failed on the constraint: `User_email_key`
```
**Cause:** Inserting duplicate value in unique field (e.g., duplicate email).
**Fix:**
```typescript
// Use upsert instead of create
const user = await db.user.upsert({
  where: { email: "user@example.com" },
  update: { name: "Updated Name" },
  create: { email: "user@example.com", name: "New User" },
})
```

### PERR-008: P2003 — Foreign Key Constraint Failed
```
Error: P2003: Foreign key constraint failed on the field: `CV_userId_fkey`
```
**Cause:** Creating record with non-existent parent (e.g., CV with invalid userId).
**Fix:** Verify parent exists first, or use nested create:
```typescript
const user = await db.user.create({
  data: {
    email: "user@example.com",
    cvs: { create: { title: "My CV", data: {} } },
  },
})
```

### PERR-009: P2025 — Record Not Found
```
Error: P2025: An operation failed because it depends on one or more records that were required but not found.
```
**Cause:** `update()` or `delete()` on non-existent record.
**Fix:**
```typescript
// Use updateMany (returns count=0 instead of throwing)
const result = await db.cv.updateMany({
  where: { id: cvId, userId: userId },
  data: { title: newTitle },
})

// Or catch and handle
try {
  await db.cv.update({ where: { id: cvId }, data: { title: newTitle } })
} catch (e) {
  if (e instanceof Prisma.PrismaClientKnownRequestError && e.code === "P2025") {
    return { error: "CV not found" }
  }
  throw e
}
```

### PERR-010: P2024 — Connection Pool Timeout
```
Error: P2024: Timed out fetching a new connection from the connection pool.
```
**Cause:** All connections in pool exhausted (too many concurrent queries, hot reload leak).
**Fix (Prisma 6):**
```env
DATABASE_URL="postgresql://...?connection_limit=20&pool_timeout=15"
```
**Fix (Prisma 7):** Configure driver adapter pool settings.
**Fix (Dev):** Use singleton pattern to prevent hot-reload connection leak:
```typescript
const globalForPrisma = globalThis as unknown as { prisma: PrismaClient | undefined }
export const db = globalForPrisma.prisma ?? new PrismaClient()
if (process.env.NODE_ENV !== "production") globalForPrisma.prisma = db
```

### PERR-011: P2011 — Null Constraint Violation
```
Error: P2011: Null constraint violation on the `User.email`
```
**Cause:** Setting required field to null.
**Fix:** Ensure all required fields have values, or make field optional with `?`.

### PERR-012: P2000 — Value Too Long
```
Error: P2000: The provided value for the column is too long for the column's type. Column: name
```
**Cause:** String exceeds database column length.
**Fix:** Add `@db.VarChar(255)` to limit, or use `@db.Text` for unlimited length.

### PERR-013: P2014 — Required Relation Violation
```
Error: P2014: The change you are trying to make would violate the required relation 'UserToCV'
```
**Cause:** Deleting a User that has CVs without cascade delete.
**Fix:** Add `onDelete: Cascade` to relation:
```prisma
model CV {
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
```

### PERR-014: P2034 — Transaction Write Conflict
```
Error: P2034: Transaction failed due to a write conflict or a deadlock. Please retry your transaction.
```
**Cause:** Concurrent transactions modifying same rows.
**Fix:** Implement retry logic:
```typescript
async function withRetry<T>(fn: () => Promise<T>, retries = 3): Promise<T> {
  for (let i = 0; i < retries; i++) {
    try {
      return await fn()
    } catch (e) {
      if (e instanceof Prisma.PrismaClientKnownRequestError && e.code === "P2034" && i < retries - 1) {
        continue
      }
      throw e
    }
  }
  throw new Error("Max retries exceeded")
}
```

---

## Schema & Migration Errors

### PERR-015: P1012 — Schema Validation Error
```
Error: P1012: Argument `output` is missing in generator block `client`.
```
**Cause (Prisma 7):** `output` field is now required in generator block.
**Fix:**
```prisma
generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}
```

### PERR-016: P3005 — Non-Empty Database for Baseline
```
Error: P3005: The database schema is not empty.
```
**Cause:** Running `prisma migrate dev` on existing database without baseline.
**Fix:**
```bash
# Create baseline migration
npx prisma migrate diff --from-empty --to-config-datasource --script > prisma/migrations/0_init/migration.sql
npx prisma migrate resolve --applied 0_init
```

### PERR-017: P3009 — Failed Migrations Block New Ones
```
Error: P3009: migrate found failed migrations in the target database, new migrations will not be applied.
```
**Cause:** Previous migration failed and is recorded as failed.
**Fix:**
```bash
# Mark as rolled back
npx prisma migrate resolve --rolled-back "migration_name"

# Or mark as applied (if you fixed the DB manually)
npx prisma migrate resolve --applied "migration_name"
```
