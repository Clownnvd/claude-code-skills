# Error Database (PERR-018 to PERR-034)

> Schema/Migration, Build/Deployment, TypeScript, Neon-Specific, and Prisma 7 Upgrade errors.
> Sources: Prisma docs, Neon docs, GitHub issues, CViet project experience.
> Date: 2026-02-27

---

## Schema & Migration Errors (continued)

### PERR-018: P3014 — Shadow Database Creation Failed
```
Error: P3014: Prisma Migrate could not create the shadow database.
```
**Cause:** Insufficient permissions on Neon (free tier) or missing shadow DB URL.
**Fix:**
```typescript
// prisma.config.ts
export default defineConfig({
  datasource: {
    url: env("DATABASE_URL"),
    shadowDatabaseUrl: env("SHADOW_DATABASE_URL"),
  },
})
```
Or use `db push` instead of `migrate dev` for prototyping.

### PERR-019: P3019 — Provider Mismatch
```
Error: P3019: The datasource provider does not match the one specified in migration_lock.toml
```
**Cause:** Changed database provider (e.g., SQLite -> PostgreSQL) without resetting migrations.
**Fix:**
```bash
# Delete migrations directory and start fresh
rm -rf prisma/migrations
npx prisma migrate dev --name init
```

---

## Build & Deployment Errors

### PERR-020: Prisma Client Not Generated
```
Error: @prisma/client did not initialize yet. Please run "prisma generate"
```
**Cause:** Vercel/CI cache skips postinstall, so `prisma generate` never runs.
**Fix (package.json):**
```json
{
  "scripts": {
    "postinstall": "prisma generate",
    "build": "prisma generate && next build"
  }
}
```

### PERR-021: Build Without Database
```
Error: P1001: Can't reach database server at `localhost`:`5432`
```
**Cause:** `prisma generate` or `prisma db push` runs during CI build without database.
**Fix:** Use fake DATABASE_URL for generate (it only needs schema, not DB):
```bash
DATABASE_URL="postgresql://fake:fake@localhost/fake" pnpm build
```

### PERR-022: Prisma Client Out of Sync
```
Error: The column `newColumn` does not exist in the current database.
```
**Cause:** Schema changed but `prisma generate` not re-run. Vercel cache issue.
**Fix:** Clear Vercel build cache or add `prisma generate` to build script.
See PERR-020 fix.

### PERR-023: Cannot Find Module (Prisma 7 Output Path)
```
Error: Cannot find module '../generated/prisma' or its corresponding type declarations
```
**Cause (Prisma 7):** Output path not set, or generate not run after schema change.
**Fix:**
```prisma
generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"   // Relative to schema.prisma
}
```
Then run: `npx prisma generate`

---

## TypeScript & Type Errors

### PERR-024: Prisma.JsonValue Not Castable
```
Error: Type 'JsonValue' is not assignable to type 'CVData'
```
**Cause:** Prisma's Json field returns `Prisma.JsonValue` (union type), not your custom type.
**Fix (double-cast):**
```typescript
const cvData = cv.data as unknown as CVData
```
**Fix (prisma-json-types-generator):**
```prisma
model CV {
  /// [CVData]
  data Json
}
```
```typescript
declare global {
  namespace PrismaJson {
    type CVData = {
      personal: { name: string; email: string; /* ... */ }
      experience: Array<{ company: string; role: string; /* ... */ }>
      // ...
    }
  }
}
```

### PERR-025: Type Error on Relation Include
```
Error: Type '{ user: true }' is not assignable to parameter of type '...'
```
**Cause:** Prisma Client out of sync with schema (missing relation).
**Fix:** Regenerate: `npx prisma generate`

### PERR-026: Type Error on Enum Comparison
```
Error: Type '"FREE"' is not assignable to type 'Plan'
```
**Cause:** Using string literal instead of enum import.
**Fix:**
```typescript
import { Plan } from "@prisma/client" // Prisma 6
import { Plan } from "../generated/prisma" // Prisma 7

// Then use:
where: { plan: Plan.FREE }
// Or (also works):
where: { plan: "FREE" }
```

---

## Neon-Specific Errors

### PERR-027: Neon Compute Suspended
```
Error: P1001: Can't reach database server ... (connection refused)
```
**Cause:** Neon compute auto-suspended after inactivity (free tier: 5 min).
**Fix:**
```env
DATABASE_URL="postgresql://...?connect_timeout=15&sslmode=require"
```

### PERR-028: Neon Branch Not Found
```
Error: P1003: Database `neondb` does not exist
```
**Cause:** Wrong branch endpoint in connection string.
**Fix:** Go to Neon Console > Branches > Select correct branch > Copy connection string.

### PERR-029: Neon Connection Limit Exceeded
```
FATAL: remaining connection slots are reserved for roles with the SUPERUSER attribute
```
**Cause:** Exceeded max_connections (free tier: 100).
**Fix:** Use pooled connection string (PgBouncer supports 10,000 concurrent), reduce connection_limit parameter.

### PERR-030: Edge Runtime + Prisma TCP Failure
```
Error: PrismaClientInitializationError: Prisma Client cannot run in the Edge Runtime
```
**Cause:** Edge Runtime cannot make TCP connections (needed for PostgreSQL).
**Fix:** Use Node.js runtime in proxy.ts (Next.js 16):
```typescript
// src/proxy.ts
export const runtime = "nodejs" // NOT "edge"

export function proxy(request: Request) {
  // Prisma works here
}
```

---

## Prisma 7 Upgrade-Specific Errors

### PERR-031: Missing Driver Adapter
```
Error: PrismaClientInitializationError: No driver adapter provided
```
**Cause (Prisma 7):** Driver adapters are now mandatory.
**Fix:** Install and configure adapter:
```bash
pnpm add @prisma/adapter-neon   # For Neon
# OR
pnpm add @prisma/adapter-pg pg  # For generic PostgreSQL
```
```typescript
import { PrismaNeon } from "@prisma/adapter-neon"
const adapter = new PrismaNeon({ connectionString: process.env.DATABASE_URL! })
const prisma = new PrismaClient({ adapter })
```

### PERR-032: $use Middleware Removed
```
Error: prisma.$use is not a function
```
**Cause (Prisma 7):** Client middleware ($use) removed.
**Fix:** Migrate to Client Extensions:
```typescript
// BEFORE (v6)
prisma.$use(async (params, next) => {
  console.log(params.model, params.action)
  return next(params)
})

// AFTER (v7)
const prisma = new PrismaClient().$extends({
  query: {
    $allModels: {
      async $allOperations({ model, operation, args, query }) {
        console.log(model, operation)
        return query(args)
      },
    },
  },
})
```

### PERR-033: Accelerate URL in Driver Adapter
```
Error: Driver adapter failed to connect: invalid connection string
```
**Cause:** Passing `prisma://` or `prisma+postgres://` URL to a driver adapter.
**Fix:** Driver adapters expect direct PostgreSQL URLs. For Accelerate:
```typescript
import { withAccelerate } from "@prisma/extension-accelerate"

const prisma = new PrismaClient({
  accelerateUrl: process.env.ACCELERATE_URL,
}).$extends(withAccelerate())
```

### PERR-034: Auto Env Loading Removed
```
Error: Environment variable not found: DATABASE_URL
```
**Cause (Prisma 7):** .env files no longer auto-loaded.
**Fix:** Add dotenv import to prisma.config.ts:
```typescript
import "dotenv/config"  // ADD THIS LINE
import { defineConfig, env } from "prisma/config"

export default defineConfig({
  datasource: { url: env("DATABASE_URL") },
})
```
