{
  "skill": "api",
  "eval_name": "eval-verification-loop",
  "description": "Verify the compile-test-rescore cycle, regression detection, and fix idempotency for api-fix.",
  "tests": [
    {
      "id": "compile-test-verification",
      "name": "Compile + Test Verification",
      "prompt": "Apply the CSP Hardening fix and verify compilation and tests pass without regression",
      "setup": "Scorecard with HIGH issue: API routes missing CSP headers (Security 5/10). Apply the CSP Hardening fix from `security-auth.md` which adds `Content-Security-Policy` to the proxy middleware.",
      "input_files": ["references/fix/verification.md", "references/scoring/scoring-workflow.md"],
      "expectations": [
        "Apply the CSP header fix to `middleware.ts` or proxy config",
        "Run `npx tsc --noEmit`. Verify zero type errors",
        "Run `pnpm test`. Verify all existing API route tests still pass",
        "Verify new CSP header string is valid (no syntax errors in directives)"
      ],
      "pass_criteria": "`tsc --noEmit` exits 0. Test suite passes with same count (no tests deleted). CSP directive parses without error. No broken imports from middleware changes.",
      "fail_indicators": [
        "Type error in header types, test regression in route handlers, or malformed CSP string"
      ]
    },
    {
      "id": "re-score-improvement-verification",
      "name": "Re-Score Improvement Verification",
      "prompt": "Apply fixes for Security and Rate Limiting categories and verify re-score improvement",
      "setup": "Initial api-scoring scorecard: Security 5/10, Rate Limiting 4/10, Input Validation 6/10. Total 58/100 (C). Apply fixes for CSP headers (Security) and per-user rate limiting (Rate Limiting).",
      "input_files": ["references/fix/verification.md", "references/scoring/scoring-workflow.md"],
      "expectations": [
        "Run api-fix for both issues",
        "Invoke `api-scoring` to produce a new scorecard",
        "Compare per-category scores: Security, Rate Limiting must increase",
        "Verify Input Validation, Error Handling, and all other categories remain at or above pre-fix scores"
      ],
      "pass_criteria": "Security >= 7/10 (was 5). Rate Limiting >= 6/10 (was 4). No category dropped below its pre-fix score. Total weighted score increased. Comparison table matches `references/verification.md` template.",
      "fail_indicators": [
        "Any unfixed category score decreased, or fixed categories show no improvement"
      ]
    },
    {
      "id": "regression-detection",
      "name": "Regression Detection",
      "prompt": "Apply a rate limiting fix that introduces a Performance regression and verify pipeline detects it",
      "setup": "Initial scorecard: Security 7/10, Rate Limiting 6/10, Performance 8/10. Apply a rate limiting fix that adds synchronous Redis lookups to every request, regressing Performance from 8/10 to 5/10.",
      "input_files": ["references/fix/verification.md", "references/scoring/scoring-workflow.md"],
      "expectations": [
        "Apply the rate limiting fix with blocking Redis calls",
        "Run `api-scoring` re-score",
        "Verify pipeline detects Performance dropped from 8 to 5 (delta -3)",
        "Verify pipeline halts further fixes and flags the regression"
      ],
      "pass_criteria": "Pipeline detects the Performance regression. Output includes: which category regressed, the before/after delta, and a recommendation to revert the rate limiting change. Pipeline does not continue to the next fix.",
      "fail_indicators": [
        "Pipeline ignores the Performance drop and continues fixing, or reports overall improvement without flagging the per-category regression"
      ]
    },
    {
      "id": "fix-idempotency",
      "name": "Fix Idempotency",
      "prompt": "Run api-fix with an already-fixed rate limiting issue and verify no changes are made",
      "setup": "Scorecard with HIGH issue: no per-user rate limiting. The `rateLimit()` function in `src/lib/api/rate-limit.ts` already has `userId` parameter and key prefix `user:${userId}` from a previous fix run.",
      "input_files": ["references/fix/verification.md", "references/scoring/scoring-workflow.md"],
      "expectations": [
        "Run api-fix with the same rate limiting issue",
        "Check `git diff` after the fix attempt",
        "Run `api-scoring` and compare scores to the post-first-fix scorecard"
      ],
      "pass_criteria": "No files modified (`git diff` is empty or unchanged). Score remains identical to post-first-fix score. Skill reports \"already applied\" or \"no changes needed\" for the rate limiting item. No duplicate code blocks inserted.",
      "fail_indicators": [
        "Duplicate `userId` parameter added, wrapper function re-created, or score changes from the second application"
      ]
    }
  ]
}
